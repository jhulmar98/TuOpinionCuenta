<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tu Opinión Cuenta</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Tu Opinión Cuenta</h1>

    <!-- Campos universales (texto primero) -->
    <div class="grid">
      <div class="kpi">
        <div class="lbl">🔖 Placa / DNI</div>
        <input id="placaInput" class="input" type="text" placeholder="Placa del vehículo o DNI del sereno">
      </div>
      <div class="kpi">
        <div class="lbl">🪪 Identificador</div>
        <input id="vehiculoInput" class="input" type="text" placeholder="Nombre del sereno o Tipo de vehículo">
      </div>
      <div class="kpi">
        <div class="lbl">🏷️ Sector / Cargo</div>
        <input id="sectorInput" class="input" type="text" placeholder="Sector del vehículo o Cargo del sereno">
      </div>
    </div>

    <!-- Calificación con caritas -->
    <div class="rate">
      <h2 class="sec">Calificación del servicio</h2>

      <div class="qblock">
        <div class="qlabel">1. Presentación personal</div>
        <div class="faces" aria-label="Calificar presentación personal">
          <input type="radio" name="rating1" id="r1_1" value="1"><label for="r1_1" title="Muy mal">😭</label>
          <input type="radio" name="rating1" id="r1_2" value="2"><label for="r1_2" title="Mal">😢</label>
          <input type="radio" name="rating1" id="r1_3" value="3"><label for="r1_3" title="Regular">😐</label>
          <input type="radio" name="rating1" id="r1_4" value="4"><label for="r1_4" title="Bien">🙂</label>
          <input type="radio" name="rating1" id="r1_5" value="5"><label for="r1_5" title="Excelente">😄</label>
        </div>
      </div>

      <div class="qblock">
        <div class="qlabel">2. Limpieza del vehículo</div>
        <div class="faces" aria-label="Calificar limpieza">
          <input type="radio" name="rating2" id="r2_1" value="1"><label for="r2_1">😭</label>
          <input type="radio" name="rating2" id="r2_2" value="2"><label for="r2_2">😢</label>
          <input type="radio" name="rating2" id="r2_3" value="3"><label for="r2_3">😐</label>
          <input type="radio" name="rating2" id="r2_4" value="4"><label for="r2_4">🙂</label>
          <input type="radio" name="rating2" id="r2_5" value="5"><label for="r2_5">😄</label>
        </div>
      </div>

      <div class="qblock">
        <div class="qlabel">3. ¿Llegó rápido?</div>
        <div class="faces" aria-label="Calificar rapidez">
          <input type="radio" name="rating3" id="r3_1" value="1"><label for="r3_1">😭</label>
          <input type="radio" name="rating3" id="r3_2" value="2"><label for="r3_2">😢</label>
          <input type="radio" name="rating3" id="r3_3" value="3"><label for="r3_3">😐</label>
          <input type="radio" name="rating3" id="r3_4" value="4"><label for="r3_4">🙂</label>
          <input type="radio" name="rating3" id="r3_5" value="5"><label for="r3_5">😄</label>
        </div>
      </div>

      <div class="qblock">
        <div class="qlabel">4. ¿Solucionó el problema?</div>
        <div class="faces" aria-label="Calificar solución">
          <input type="radio" name="rating4" id="r4_1" value="1"><label for="r4_1">😭</label>
          <input type="radio" name="rating4" id="r4_2" value="2"><label for="r4_2">😢</label>
          <input type="radio" name="rating4" id="r4_3" value="3"><label for="r4_3">😐</label>
          <input type="radio" name="rating4" id="r4_4" value="4"><label for="r4_4">🙂</label>
          <input type="radio" name="rating4" id="r4_5" value="5"><label for="r4_5">😄</label>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:14px">
      <button id="enviarBtn" class="btn btn-primary">Enviar calificación</button>
    </div>

    <div class="hint">
      (Opcional) Si abres con <code>#PLACA|IDENTIFICADOR|SECTOR</code>, se llenan los campos; pero puedes escribirlos manualmente.
    </div>
  </div>
</div>

<!-- Overlay: envío / gracias -->
<div id="overlay" class="overlay">
  <div id="overlayBox" class="overlay-box">
    <div id="spinner" class="spinner" aria-hidden="true"></div>
    <div id="overlayMsg" class="overlay-msg">Se está enviando su respuesta…</div>
  </div>
</div>

<!-- Firebase + Firestore -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // Config de tu proyecto
  const firebaseConfig = {
    apiKey: "AIzaSyAzqBW_0QduNdRk2lHFzgh8cOqHOzCRq8A",
    authDomain: "tu-opinion-importa-msi.firebaseapp.com",
    projectId: "tu-opinion-importa-msi",
    storageBucket: "tu-opinion-importa-msi.firebasestorage.app",
    messagingSenderId: "933860804282",
    appId: "1:933860804282:web:8afef3b37b9d01fdca6483",
    measurementId: "G-ZM3EM2Z4W7"
  };

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch (_) {}
  const db = getFirestore(app);

  // Helpers
  const $ = (s) => document.querySelector(s);
  const getFaceValue = (name) => {
    const el = document.querySelector(`input[name="${name}"]:checked`);
    return el ? Number(el.value) : 0;
  };
  const parseHashPrefill = () => {
    const i = location.href.indexOf("#");
    if (i < 0) return;
    let frag = decodeURIComponent(location.href.slice(i + 1)).trim();
    let parts = frag.split("|");
    if (parts.length < 3) parts = frag.split(",");
    const [placa="", ident="", sector=""] = parts.map(s => s.trim());
    if (placa && !$("#placaInput").value) $("#placaInput").value = placa;
    if (ident && !$("#vehiculoInput").value) $("#vehiculoInput").value = ident;
    if (sector && !$("#sectorInput").value) $("#sectorInput").value = sector;
  };

  // Overlay states
  function showSending() {
    const overlay = $("#overlay");
    const box = $("#overlayBox");
    $("#spinner").style.display = "inline-block";
    $("#overlayMsg").textContent = "Se está enviando su respuesta…";
    box.classList.remove("success");
    overlay.classList.add("show");
  }

  function showThanks5s() {
    const overlay = $("#overlay");
    const box = $("#overlayBox");
    // Cambiar a estado éxito (rojo con letras blancas, sin spinner)
    $("#spinner").style.display = "none";
    $("#overlayMsg").textContent = "¡Gracias por su calificación!";
    box.classList.add("success");
    // Mantener 5s y luego ocultar
    setTimeout(() => overlay.classList.remove("show"), 5000);
  }

  let sending = false;
  async function guardar() {
    if (sending) return; // antirebote
    const placa  = $("#placaInput").value.trim();
    const ident  = $("#vehiculoInput").value.trim();
    const sector = $("#sectorInput").value.trim();
    const r1 = getFaceValue("rating1");
    const r2 = getFaceValue("rating2");
    const r3 = getFaceValue("rating3");
    const r4 = getFaceValue("rating4");

    const errores = [];
    if (!placa) errores.push("Placa / DNI es obligatorio.");
    if (!ident) errores.push("Identificador es obligatorio.");
    if (!sector) errores.push("Sector / Cargo es obligatorio.");
    if (!r1 || !r2 || !r3 || !r4) errores.push("Responda todas las preguntas.");
    if (errores.length) { alert(errores.join("\n")); return; }

    // Tiempo local Lima + timestamps
    const tz = "America/Lima";
    const now = new Date();
    const fecha = new Intl.DateTimeFormat("es-PE",{year:"numeric",month:"2-digit",day:"2-digit", timeZone:tz}).format(now);
    const hora  = new Intl.DateTimeFormat("es-PE",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:true,timeZone:tz}).format(now);
    const timestamp_ms = now.getTime();

    const payload = {
      placa_dni: placa,
      identificador: ident,
      sector_cargo: sector,
      calificaciones: { presentacion: r1, limpieza: r2, rapidez: r3, solucion: r4 },
      fecha, hora,
      timestamp: serverTimestamp(),
      timestamp_ms
    };

    try {
      sending = true;
      $("#enviarBtn").disabled = true;
      showSending();
      await addDoc(collection(db, "encuestas"), payload);
      showThanks5s();
    } catch (e) {
      console.error(e);
      alert("No se pudo guardar. Revisa tu conexión e inténtalo de nuevo.");
      $("#overlay").classList.remove("show");
      $("#enviarBtn").disabled = false;
    } finally {
      // Rehabilitar el botón después de los 5s del overlay de gracias
      setTimeout(() => { sending = false; $("#enviarBtn").disabled = false; }, 5000);
    }
  }

  // Init
  window.addEventListener("DOMContentLoaded", () => {
    parseHashPrefill();
    $("#enviarBtn").addEventListener("click", guardar);
  });
  window.addEventListener("hashchange", parseHashPrefill);
</script>
</body>
</html>
