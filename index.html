<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ficha de AtenciÃ³n</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Ficha de AtenciÃ³n</h1>

    <!-- Datos del carro -->
    <div class="grid">
      <div class="kpi">
        <div class="lbl">ğŸš— VehÃ­culo</div>
        <div id="vehiculo" class="val">â€”</div>
      </div>
      <div class="kpi">
        <div class="lbl">ğŸ”– Placa</div>
        <div id="placa" class="val">â€”</div>
      </div>
      <div class="kpi">
        <div class="lbl">ğŸ“ Sector</div>
        <div id="sector" class="val">â€”</div>
      </div>
    </div>

    <!-- Preguntas con estrellas -->
    <div class="rate">
      <h2 class="sec">â­ CalificaciÃ³n del servicio</h2>

      <div class="qblock">
        <div class="qlabel">1. PresentaciÃ³n personal</div>
        <div class="stars">
          <input type="radio" name="rating1" id="r1_5" value="5"><label for="r1_5">â˜…</label>
          <input type="radio" name="rating1" id="r1_4" value="4"><label for="r1_4">â˜…</label>
          <input type="radio" name="rating1" id="r1_3" value="3"><label for="r1_3">â˜…</label>
          <input type="radio" name="rating1" id="r1_2" value="2"><label for="r1_2">â˜…</label>
          <input type="radio" name="rating1" id="r1_1" value="1"><label for="r1_1">â˜…</label>
        </div>
      </div>

      <div class="qblock">
        <div class="qlabel">2. Limpieza del vehÃ­culo</div>
        <div class="stars">
          <input type="radio" name="rating2" id="r2_5" value="5"><label for="r2_5">â˜…</label>
          <input type="radio" name="rating2" id="r2_4" value="4"><label for="r2_4">â˜…</label>
          <input type="radio" name="rating2" id="r2_3" value="3"><label for="r2_3">â˜…</label>
          <input type="radio" name="rating2" id="r2_2" value="2"><label for="r2_2">â˜…</label>
          <input type="radio" name="rating2" id="r2_1" value="1"><label for="r2_1">â˜…</label>
        </div>
      </div>

      <div class="qblock">
        <div class="qlabel">3. Â¿LlegÃ³ rÃ¡pido?</div>
        <div class="stars">
          <input type="radio" name="rating3" id="r3_5" value="5"><label for="r3_5">â˜…</label>
          <input type="radio" name="rating3" id="r3_4" value="4"><label for="r3_4">â˜…</label>
          <input type="radio" name="rating3" id="r3_3" value="3"><label for="r3_3">â˜…</label>
          <input type="radio" name="rating3" id="r3_2" value="2"><label for="r3_2">â˜…</label>
          <input type="radio" name="rating3" id="r3_1" value="1"><label for="r3_1">â˜…</label>
        </div>
      </div>

      <div class="qblock">
        <div class="qlabel">4. Â¿SolucionÃ³ el problema?</div>
        <div class="stars">
          <input type="radio" name="rating4" id="r4_5" value="5"><label for="r4_5">â˜…</label>
          <input type="radio" name="rating4" id="r4_4" value="4"><label for="r4_4">â˜…</label>
          <input type="radio" name="rating4" id="r4_3" value="3"><label for="r4_3">â˜…</label>
          <input type="radio" name="rating4" id="r4_2" value="2"><label for="r4_2">â˜…</label>
          <input type="radio" name="rating4" id="r4_1" value="1"><label for="r4_1">â˜…</label>
        </div>
      </div>
    </div>

    <!-- BotÃ³n para guardar -->
    <div class="row" style="margin-top:14px">
      <button id="enviarBtn" class="btn btn-primary">ğŸ’¾ Enviar calificaciÃ³n</button>
    </div>

    <div class="hint">
      AÃ±ade al final de la URL <br>
      <code>#Camioneta 40 49|EUE 519|SECTOR 1</code>
    </div>
  </div>
</div>

<script>
  // Lee "VehÃ­culo, Placa, Sector" desde el fragmento de la URL (#â€¦)
  function parseHash() {
    const frag = decodeURIComponent(location.hash.startsWith('#') ? location.hash.slice(1) : location.hash).trim();
    if (!frag) return { vehiculo:"â€”", placa:"â€”", sector:"â€”" };
    let parts = frag.split('|');
    if (parts.length < 3) parts = frag.split(',');
    const [vehiculo="", placa="", sector=""] = parts.map(s => s.trim());
    return { vehiculo: vehiculo || "â€”", placa: placa || "â€”", sector: sector || "â€”" };
  }

  function render() {
    const { vehiculo, placa, sector } = parseHash();
    document.getElementById('vehiculo').textContent = vehiculo;
    document.getElementById('placa').textContent   = placa;
    document.getElementById('sector').textContent  = sector;
  }

  function getRating(name){
    const el = document.querySelector(`input[name="${name}"]:checked`);
    return el ? Number(el.value) : 0;
  }

  addEventListener('hashchange', render);
  addEventListener('DOMContentLoaded', render);
</script>

<!-- Firebase + Firestore (modular) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // Config de tu proyecto
  const firebaseConfig = {
    apiKey: "AIzaSyAzqBW_0QduNdRk2lHFzgh8cOqHOzCRq8A",
    authDomain: "tu-opinion-importa-msi.firebaseapp.com",
    projectId: "tu-opinion-importa-msi",
    storageBucket: "tu-opinion-importa-msi.firebasestorage.app",
    messagingSenderId: "933860804282",
    appId: "1:933860804282:web:8afef3b37b9d01fdca6483",
    measurementId: "G-ZM3EM2Z4W7"
  };

  // Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch (_) {} // Analytics puede fallar en HTTP local, no es crÃ­tico.
  const db = getFirestore(app);

  // Click para guardar
  document.getElementById("enviarBtn").addEventListener("click", async () => {
    const vehiculo = document.getElementById('vehiculo').textContent.trim();
    const placa    = document.getElementById('placa').textContent.trim();
    const sector   = document.getElementById('sector').textContent.trim();

    const presentacion = getRating("rating1");
    const limpieza     = getRating("rating2");
    const rapidez      = getRating("rating3");
    const solucion     = getRating("rating4");

    // Validaciones bÃ¡sicas
    if (vehiculo === "â€”" || placa === "â€”" || sector === "â€”") {
      alert("Completa VehÃ­culo, Placa y Sector (pasa los datos en la URL).");
      return;
    }
    if (!presentacion || !limpieza || !rapidez || !solucion) {
      alert("Responde todas las preguntas de calificaciÃ³n.");
      return;
    }

    const payload = {
      vehiculo, placa, sector,
      calificaciones: { presentacion, limpieza, rapidez, solucion },
      userAgent: navigator.userAgent,
      createdAt: serverTimestamp()
    };

    try {
      await addDoc(collection(db, "encuestas"), payload);
      alert("Â¡Gracias! Tu calificaciÃ³n fue registrada.");
      // Limpia selecciones (opcional)
      document.querySelectorAll('input[type="radio"]').forEach(el => el.checked = false);
    } catch (e) {
      console.error(e);
      alert("No se pudo guardar. Revisa tu conexiÃ³n e intÃ©ntalo de nuevo.");
    }
  });
</script>
</body>
</html>
