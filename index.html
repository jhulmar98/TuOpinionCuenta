<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tu OpiniÃ³n Cuenta</title>
<link rel="stylesheet" href="styles.css">

<!-- Lector QR -->
<script src="https://unpkg.com/html5-qrcode" defer></script>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Tu OpiniÃ³n Cuenta</h1>

    <!-- Campos universales -->
    <div class="grid">
      <div class="kpi">
        <div class="lbl">ğŸ”– Placa / DNI</div>
        <input id="placaInput" class="input" type="text" placeholder="Placa del vehÃ­culo o DNI del sereno">
      </div>
      <div class="kpi">
        <div class="lbl">ğŸªª Identificador</div>
        <input id="vehiculoInput" class="input" type="text" placeholder="Nombre del sereno o Tipo de vehÃ­culo">
      </div>
      <div class="kpi">
        <div class="lbl">ğŸ·ï¸ Sector / Cargo</div>
        <input id="sectorInput" class="input" type="text" placeholder="Sector del vehÃ­culo o Cargo del sereno">
      </div>
    </div>

    <div class="row">
      <button id="scanBtn" class="btn btn-ghost">ğŸ“· Escanear QR (opcional)</button>
    </div>

    <!-- CalificaciÃ³n -->
    <div class="rate">
      <h2 class="sec">â­ CalificaciÃ³n del servicio</h2>

      <div class="qblock">
        <div class="qlabel">1. PresentaciÃ³n personal</div>
        <div class="stars">
          <input type="radio" name="rating1" id="r1_5" value="5"><label for="r1_5">â˜…</label>
          <input type="radio" name="rating1" id="r1_4" value="4"><label for="r1_4">â˜…</label>
          <input type="radio" name="rating1" id="r1_3" value="3"><label for="r1_3">â˜…</label>
          <input type="radio" name="rating1" id="r1_2" value="2"><label for="r1_2">â˜…</label>
          <input type="radio" name="rating1" id="r1_1" value="1"><label for="r1_1">â˜…</label>
        </div>
      </div>

      <div class="qblock">
        <div class="qlabel">2. Limpieza del vehÃ­culo</div>
        <div class="stars">
          <input type="radio" name="rating2" id="r2_5" value="5"><label for="r2_5">â˜…</label>
          <input type="radio" name="rating2" id="r2_4" value="4"><label for="r2_4">â˜…</label>
          <input type="radio" name="rating2" id="r2_3" value="3"><label for="r2_3">â˜…</label>
          <input type="radio" name="rating2" id="r2_2" value="2"><label for="r2_2">â˜…</label>
          <input type="radio" name="rating2" id="r2_1" value="1"><label for="r2_1">â˜…</label>
        </div>
      </div>

      <div class="qblock">
        <div class="qlabel">3. Â¿LlegÃ³ rÃ¡pido?</div>
        <div class="stars">
          <input type="radio" name="rating3" id="r3_5" value="5"><label for="r3_5">â˜…</label>
          <input type="radio" name="rating3" id="r3_4" value="4"><label for="r3_4">â˜…</label>
          <input type="radio" name="rating3" id="r3_3" value="3"><label for="r3_3">â˜…</label>
          <input type="radio" name="rating3" id="r3_2" value="2"><label for="r3_2">â˜…</label>
          <input type="radio" name="rating3" id="r3_1" value="1"><label for="r3_1">â˜…</label>
        </div>
      </div>

      <div class="qblock">
        <div class="qlabel">4. Â¿SolucionÃ³ el problema?</div>
        <div class="stars">
          <input type="radio" name="rating4" id="r4_5" value="5"><label for="r4_5">â˜…</label>
          <input type="radio" name="rating4" id="r4_4" value="4"><label for="r4_4">â˜…</label>
          <input type="radio" name="rating4" id="r4_3" value="3"><label for="r4_3">â˜…</label>
          <input type="radio" name="rating4" id="r4_2" value="2"><label for="r4_2">â˜…</label>
          <input type="radio" name="rating4" id="r4_1" value="1"><label for="r4_1">â˜…</label>
        </div>
      </div>
    </div>

    <div class="row" style="margin-top:14px">
      <button id="enviarBtn" class="btn btn-primary">ğŸ’¾ Enviar calificaciÃ³n</button>
    </div>

    <div class="hint">
      El QR puede traer: <code>PLACA_O_DNI|IDENTIFICADOR|SECTOR_O_CARGO</code> (o con comas).<br>
      TambiÃ©n puedes abrir con: <code>#PLACA|IDENTIFICADOR|SECTOR</code>
    </div>
  </div>
</div>

<!-- Modal del escÃ¡ner -->
<div id="qr-box" class="qrbox" style="display:none;">
  <div class="qrcard">
    <div class="qrheader">
      <strong>Escanear QR</strong>
      <button id="closeScan" class="btn btn-ghost">âœ–</button>
    </div>
    <div id="qr-reader" style="width: 100%;"></div>
    <div class="hint">Enfoca el cÃ³digo QR; al detectar, se rellenarÃ¡n los campos.</div>
  </div>
</div>

<!-- Firebase + lÃ³gica -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js";
  import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // Tu config
  const firebaseConfig = {
    apiKey: "AIzaSyAzqBW_0QduNdRk2lHFzgh8cOqHOzCRq8A",
    authDomain: "tu-opinion-importa-msi.firebaseapp.com",
    projectId: "tu-opinion-importa-msi",
    storageBucket: "tu-opinion-importa-msi.firebasestorage.app",
    messagingSenderId: "933860804282",
    appId: "1:933860804282:web:8afef3b37b9d01fdca6483",
    measurementId: "G-ZM3EM2Z4W7"
  };

  const app = initializeApp(firebaseConfig);
  try { getAnalytics(app); } catch (_) {}
  const db = getFirestore(app);

  // Helpers
  const $ = (s) => document.querySelector(s);
  const getRating = (name) => {
    const r = document.querySelector(`input[name="${name}"]:checked`);
    return r ? Number(r.value) : 0;
  };
  const parsePayload = (raw) => {
    if (!raw) return { placa:"", vehiculo:"", sector:"" };
    let frag = raw.trim();
    const i = frag.indexOf("#");
    if (i >= 0 && i < frag.length - 1) frag = decodeURIComponent(frag.slice(i + 1));
    let parts = frag.split("|");
    if (parts.length < 3) parts = frag.split(",");
    const [placa="", vehiculo="", sector=""] = parts.map(s => s.trim());
    return { placa, vehiculo, sector };
  };

  // Prefill desde #... si existe (sin bloquear ediciÃ³n)
  function prefillFromHashOnce() {
    const { placa, vehiculo, sector } = parsePayload(location.href);
    if (!$("#placaInput").value)   $("#placaInput").value = placa;
    if (!$("#vehiculoInput").value)$("#vehiculoInput").value = vehiculo;
    if (!$("#sectorInput").value)  $("#sectorInput").value = sector;
  }

  // Guardar
  async function guardar() {
    const placa = $("#placaInput").value.trim();
    const vehiculo = $("#vehiculoInput").value.trim();
    const sector = $("#sectorInput").value.trim();
    const presentacion = getRating("rating1");
    const limpieza     = getRating("rating2");
    const rapidez      = getRating("rating3");
    const solucion     = getRating("rating4");

    const errores = [];
    if (!placa) errores.push("Placa / DNI es obligatorio.");
    if (!vehiculo) errores.push("Identificador es obligatorio.");
    if (!sector) errores.push("Sector / Cargo es obligatorio.");
    if (!presentacion || !limpieza || !rapidez || !solucion) errores.push("Responde todas las preguntas.");

    if (errores.length) { alert(errores.join("\n")); return; }

    // Tiempo local Lima + timestamps
    const tz = "America/Lima";
    const now = new Date();
    const fecha = new Intl.DateTimeFormat("es-PE",{year:"numeric",month:"2-digit",day:"2-digit", timeZone:tz}).format(now);
    const hora  = new Intl.DateTimeFormat("es-PE",{hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:true,timeZone:tz}).format(now);
    const timestamp_ms = now.getTime();

    const payload = {
      placa_dni: placa,
      identificador: vehiculo,     // nombre sereno o tipo de vehÃ­culo
      sector_cargo: sector,        // sector vehÃ­culo o cargo sereno
      calificaciones: {
        presentacion, limpieza, rapidez, solucion
      },
      fecha, hora,
      timestamp: serverTimestamp(),
      timestamp_ms
    };

    try {
      await addDoc(collection(db, "encuestas"), payload);
      alert("Â¡Muchas gracias! Tu calificaciÃ³n fue registrada.");
      document.querySelectorAll('input[type="radio"]').forEach(el => el.checked = false);
      // Si quieres limpiar campos de texto, descomenta:
      // $("#placaInput").value = ""; $("#vehiculoInput").value = ""; $("#sectorInput").value = "";
    } catch (e) {
      console.error(e);
      alert("No se pudo guardar. Revisa tu conexiÃ³n e intÃ©ntalo de nuevo.");
    }
  }

  // QR Scanner
  let scanner = null;
  function abrirScanner() {
    $("#qr-box").style.display = "grid";
    if (!scanner) {
      scanner = new Html5QrcodeScanner("qr-reader", { fps: 10, qrbox: 250, rememberLastUsedCamera: true, showTorchButtonIfSupported: true });
      scanner.render(onScanSuccess, () => {});
    }
  }
  async function cerrarScanner() {
    $("#qr-box").style.display = "none";
    if (scanner) { try { await scanner.clear(); } catch(_) {} scanner = null; $("#qr-reader").innerHTML=""; }
  }
  function onScanSuccess(text) {
    const { placa, vehiculo, sector } = parsePayload(text);
    if (placa)   $("#placaInput").value = placa;
    if (vehiculo)$("#vehiculoInput").value = vehiculo;
    if (sector)  $("#sectorInput").value = sector;
    cerrarScanner();
  }

  // Eventos
  window.addEventListener("DOMContentLoaded", () => {
    prefillFromHashOnce();
    $("#scanBtn").addEventListener("click", abrirScanner);
    $("#closeScan").addEventListener("click", cerrarScanner);
    $("#enviarBtn").addEventListener("click", guardar);
  });
</script>

<!-- Toast (opcional si usas estilos .toast) -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>
</body>
</html>
